<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Huntington Councilman Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    #map { width:100%; height:100vh; }
    #ui {
      position:absolute; top:10px; left:10px; z-index:1000;
      background:#fff; padding:10px; border-radius:8px;
      box-shadow:0 2px 10px rgba(0,0,0,.15); max-width:400px;
    }
    .muted { color:#555; font-size:12px; }
    .legend {
      position:absolute; bottom:12px; left:10px; z-index:1000;
      background:#fff; padding:8px 10px; border-radius:8px;
      box-shadow:0 2px 10px rgba(0,0,0,.15); font-size:12px;
    }
    .legend .scale {
      height:10px; width:220px;
      background:linear-gradient(90deg,#00039b,white,#ff2400);
      border-radius:4px; margin:6px 0;
    }
    .legend .ticks { display:flex; justify-content:space-between; }

    .ed-label {
      font-size: 12px; font-weight: 700; color: #000;
      text-align: center; white-space: nowrap;
      text-shadow: 0 0 3px #fff;
    }
    .ed-label--highlight {
      background: #ffffff;
      border: 3px solid #e02424;
      border-radius: 50%;
      width: 28px; height: 28px;
      display: flex; align-items: center; justify-content: center;
      padding: 0;
      box-shadow: 0 0 6px rgba(0,0,0,0.45);
      font-weight: 800;
      font-size: 12px;
      line-height: 1;
    }
    .tbl { border-collapse:collapse; width:100%; font-size:12px; }
    .tbl td { padding:2px 4px; border-bottom:1px solid #eee; }
  </style>
</head>
<body>
  <div id="ui">
    <b>Upload CSV</b><br>
    <input type="file" id="csvFile" accept=".csv"/>
    <div class="muted" style="margin-top:6px" id="status"></div>
  </div>

  <div class="legend">
    <div><b>Heatmap:</b> Percent Difference (GOP % – Opposition %)</div>
    <div class="scale"></div>
    <div class="ticks"><span>-100%</span><span>0%</span><span>+100%</span></div>
  </div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chroma-js/2.1.0/chroma.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6.5.0/turf.min.js"></script>

  <script>
    const map = L.map('map').setView([40.85, -73.4], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ maxZoom:19 }).addTo(map);
    let geojsonLayer;
    const labels = L.layerGroup().addTo(map);
    const statusEl = document.getElementById('status');

    const COLS = {
      key: 'PRECINCT_ID',
      ed: 'ED',
      zone: 'Zone',
      members: 'Committee Members',
      gop: 'GOP Candidate Votes',
      opp: 'Opposition Candidate Vote',
      total: 'Total Votes',
      gopPct: 'GOP Candidate Percent',
      oppPct: 'Opposition Candidate Percent',
      margin: 'Percent Difference'
    };

    const toNum = v => { const n = Number(String(v??'').replace(/[, ]/g,'')); return Number.isFinite(n)?n:0; };
    const fmtInt = v => isNaN(v)||v==null ? '—' : `${Math.round(v)}`;
    const nl2br = s => String(s??'').replace(/\r?\n/g,'<br>');
    const getColor = x => chroma.scale(['#00039b', '#ffffff', '#ff2400']).domain([-1,0,1]).mode('lab')(x).hex();

    const toPctNumber = v => {
      if (v == null) return null;
      const s = String(v).trim().replace('%','');
      const n = Number(s.replace(/[, ]/g,''));
      return Number.isFinite(n) ? ((n > 1) ? n : n * 100) : null;
    };
    const fmtPctSmart = v => {
      const n = toPctNumber(v);
      return (n == null) ? '—' : `${n.toFixed(1)}%`;
    };
    const isHighlighted = props => {
      const val = props['HIGHLIGHT'] ?? props['Highlight'] ?? props['highlight'];
      return val && String(val).trim().toUpperCase() === 'X';
    };

    function drawPopup(p) {
      const ed = p[COLS.ed] ?? '';
      const z = p[COLS.zone] ?? '';
      const cm = nl2br(p[COLS.members] ?? '');
      const gop = toNum(p[COLS.gop]), opp = toNum(p[COLS.opp]);
      const tot = toNum(p[COLS.total]);
      const gopPct = p[COLS.gopPct], oppPct = p[COLS.oppPct], margin = p[COLS.margin];

      let html = `<div style="min-width:260px">`;
      html += `<div><b>ED:</b> ${ed}</div>`;
      if (z) html += `<div><b>Zone:</b> ${z}</div>`;
      if (cm) html += `<hr><div><b>Committee Members</b><br>${cm}</div>`;
      html += `<hr><table class="tbl">`;
      html += `<tr><td><b>GOP Votes</b></td><td style="text-align:right">${fmtInt(gop)}</td></tr>`;
      html += `<tr><td><b>Opposition Votes</b></td><td style="text-align:right">${fmtInt(opp)}</td></tr>`;
      html += `<tr><td><b>Total Votes</b></td><td style="text-align:right">${fmtInt(tot)}</td></tr>`;
      html += `<tr><td>GOP %</td><td style="text-align:right">${fmtPctSmart(gopPct)}</td></tr>`;
      html += `<tr><td>Opposition %</td><td style="text-align:right">${fmtPctSmart(oppPct)}</td></tr>`;
      html += `<tr><td><b>Margin</b></td><td style="text-align:right">${fmtPctSmart(margin)}</td></tr>`;
      html += `</table></div>`;
      return html;
    }

    function applyData(geo, csvRows) {
      if (geojsonLayer) map.removeLayer(geojsonLayer);
      labels.clearLayers();

      const byPrecinct = new Map();
      csvRows.forEach(row => {
        const key = row[COLS.key];
        if (key) byPrecinct.set(String(key).trim(), row);
      });

      geo.features.forEach(f => {
        const props = f.properties || {};
        const key = props[COLS.key];
        if (key && byPrecinct.has(String(key).trim())) {
          f.properties = { ...props, ...byPrecinct.get(String(key).trim()) };
        }
      });

      geojsonLayer = L.geoJSON(geo, {
        style: function (feature) {
          const raw = feature.properties[COLS.margin];
          const pct = toPctNumber(raw);
          const norm = isNaN(pct) ? 0 : pct / 100;
          return {
            fillColor: getColor(norm),
            color: "#222",
            weight: 1,
            fillOpacity: isHighlighted(feature.properties) ? 1 : 0.25
          };
        },
        onEachFeature: function (feature, layer) {
          const p = feature.properties;
          layer.bindPopup(drawPopup(p));
          try {
            const center = turf.centroid(feature).geometry.coordinates;
            const txt = p[COLS.ed] ?? '';
            const label = L.marker([center[1], center[0]], {
              icon: L.divIcon({
                className: isHighlighted(p) ? 'ed-label ed-label--highlight' : 'ed-label',
                html: `<div>${txt}</div>`,
                iconSize: isHighlighted(p) ? [28,28] : [40,20],
                iconAnchor: isHighlighted(p) ? [14,14] : [20,10]
              }),
              interactive: false
            });
            labels.addLayer(label);
          } catch (_) {}
        }
      }).addTo(map);
    }

    let baseGeoJSON = null;
    fetch('Election_District.geojson')
      .then(res => res.json())
      .then(g => { baseGeoJSON = g; applyData(g, []); });

    document.getElementById('csvFile').addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) return;
      Papa.parse(file, {
        header: true,
        dynamicTyping: false,
        skipEmptyLines: 'greedy',
        complete: res => {
          applyData(JSON.parse(JSON.stringify(baseGeoJSON)), res.data);
          statusEl.textContent = `Loaded ${res.data.length} rows`;
        }
      });
    });
  </script>
</body>
</html>
