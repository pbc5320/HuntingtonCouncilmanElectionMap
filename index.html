<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Huntington Councilman Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body { margin: 0; font-family: Arial, sans-serif; }
    #map { width: 100%; height: 100vh; }
    #ui {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1000;
      background: white;
      padding: 12px;
      border-radius: 6px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    .legend {
      background: white;
      padding: 8px;
      position: absolute;
      bottom: 10px;
      left: 10px;
      font-size: 12px;
      border-radius: 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }
    .legend div {
      margin-bottom: 4px;
    }
    .circle-label {
      font-size: 12px;
      color: black;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="ui">
    <strong>Upload CSV</strong><br />
    <input type="file" id="fileInput" />
    <p style="font-size:12px;">
      Must include column <code>Committee Members</code>.<br>
      Optional: <code>Highlight</code> (put X to show).
    </p>
  </div>
  <div class="legend" id="legend">
    <strong>Fill:</strong> Margin (Republican % â€“ Opposition %)
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/chroma-js@2.1.0/chroma.min.js"></script>
  <script>
    const map = L.map('map').setView([40.868, -73.4], 11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    let geojsonLayer;

    // Load base GeoJSON
    fetch('Election_District.geojson')
      .then(res => res.json())
      .then(geo => {
        geojsonLayer = L.geoJSON(geo, {
          style: () => ({ weight: 1, color: '#222', fillOpacity: 0.7 }),
          onEachFeature: (feature, layer) => {
            const ed = feature.properties.ED || feature.properties.ED_Number || feature.properties.PRECINCTID;
            layer.bindTooltip(ed.toString(), { permanent: true, direction: 'center', className: 'circle-label' });
          }
        }).addTo(map);
      });

    function parseCSV(text) {
      const [headerLine, ...lines] = text.trim().split('\n');
      const headers = headerLine.split(',').map(h => h.trim());
      return lines.map(line => {
        const values = line.split(',').map(v => v.trim());
        const row = {};
        headers.forEach((h, i) => row[h] = values[i]);
        return row;
      });
    }

    function colorScale(margin) {
      if (isNaN(margin)) return '#ccc';
      return chroma.scale(['blue', 'white', 'red']).domain([-100, 0, 100])(margin).hex();
    }

    document.getElementById('fileInput').addEventListener('change', function(e) {
      const file = e.target.files[0];
      const reader = new FileReader();
      reader.onload = function() {
        const csvData = parseCSV(reader.result);
        const dataMap = {};
        csvData.forEach(row => {
          const ed = row["ED"] || row["PRECINCTID"] || row["ED Number"];
          if (ed) dataMap[parseInt(ed)] = row;
        });

        geojsonLayer.eachLayer(layer => {
          const ed = parseInt(layer.feature.properties.ED || layer.feature.properties.ED_Number || layer.feature.properties.PRECINCTID);
          const row = dataMap[ed];
          if (!row) {
            layer.setStyle({ fillColor: '#ccc', fillOpacity: 0.1 });
            return;
          }

          const margin = parseFloat(row["Percent Difference"]) || 0;
          layer.setStyle({ fillColor: colorScale(margin) });

          const popup = `
            <b>Election District:</b> ${ed}<br/>
            <b>Committee Members:</b><br>${(row["Committee Members"] || "VACANT").replace(/\n/g, "<br>")}<br/>
            <b>AD:</b> ${row["AD"]}<br/>
            <b>SD:</b> ${row["SD"]}<br/>
            <b>CD:</b> ${row["CD"]}<br/>
            <b>LD:</b> ${row["LD"]}<br/>
            <b>GOP Candidate Votes:</b> ${row["GOP Candidate Votes"]}<br/>
            <b>Opposition Candidate Vote:</b> ${row["Opposition Candidate Vote"]}<br/>
            <b>GOP Candidate Percent:</b> ${row["GOP Candidate Percent"]}<br/>
            <b>Opposition Candidate Percent:</b> ${row["Opposition Candidate Percent"]}<br/>
            <b>Percent Difference:</b> ${row["Percent Difference"]}<br/>
            <b>Total Votes:</b> ${row["Total Votes"]}
          `;
          layer.bindPopup(popup);

          // Optional highlight
          if (row["Highlight"] && row["Highlight"].toUpperCase() === "X") {
            const center = layer.getBounds().getCenter();
            L.circleMarker(center, {
              radius: 18,
              color: 'red',
              weight: 3,
              fillColor: 'white',
              fillOpacity: 1
            }).addTo(map).bindTooltip(ed.toString(), {
              permanent: true,
              direction: 'center',
              className: 'circle-label'
            });
          }
        });
      };
      reader.readAsText(file);
    });
  </script>
</body>
</html>
