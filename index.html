<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Huntington Councilman Election Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body { margin: 0; font-family: system-ui, sans-serif; }
    #map { width: 100%; height: 100vh; }
    #ui {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1000;
      background: #fff;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,.15);
      max-width: 400px;
    }
    .legend {
      position: absolute;
      bottom: 10px;
      left: 10px;
      background: white;
      padding: 8px;
      border-radius: 5px;
      font-size: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }
  </style>
</head>
<body>
<div id="ui">
  <strong>Upload CSV</strong><br />
  <input type="file" id="csvFile" accept=".csv" /><br />
  <small>Must include column <code>Committee Members</code>.<br />
  Optional: <code>Highlight</code> (put <b>X</b> to show).</small>
</div>
<div id="map"></div>
<div class="legend" id="legend"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://unpkg.com/chroma-js@2.1.0/chroma.min.js"></script>
<script>
const map = L.map('map').setView([40.867, -73.4], 11);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19,
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

let geojsonLayer;
let edLabels = [];

fetch('Election_District.geojson')
  .then(response => response.json())
  .then(data => {
    geojsonLayer = L.geoJSON(data, {
      style: {
        color: "#999",
        weight: 1,
        fillOpacity: 0.2
      },
      onEachFeature: function (feature, layer) {
        layer.bindTooltip(feature.properties.PRECINCT_ID || feature.properties.ED || '', {
          permanent: true,
          direction: 'center',
          className: 'label-style'
        });
      }
    }).addTo(map);
  });

function updateLegend(min, max) {
  const legend = document.getElementById('legend');
  const scale = chroma.scale(["#2b2d42", "#edf2f4", "#d90429"]).domain([min, 0, max]);
  const steps = 5;
  let html = '<b>Fill:</b> Margin (Republican % âˆ’ Opposition %)<br>'; 
  for (let i = 0; i <= steps; i++) {
    const val = min + ((max - min) / steps) * i;
    html += `<div style="display:inline-block; width:20px; height:10px; background:${scale(val)}"></div> ${val.toFixed(1)}&nbsp;`;
  }
  legend.innerHTML = html;
}

document.getElementById('csvFile').addEventListener('change', function (e) {
  const file = e.target.files[0];
  if (!file) return;
  Papa.parse(file, {
    header: true,
    skipEmptyLines: true,
    complete: function (results) {
      const csvData = results.data;
      const dataMap = {};
      let minMargin = Infinity, maxMargin = -Infinity;
      csvData.forEach(row => {
        const id = row["PRECINCT_ID"];
        const margin = parseFloat(row["Percent Difference"]);
        if (!isNaN(margin)) {
          dataMap[id] = row;
          if (margin < minMargin) minMargin = margin;
          if (margin > maxMargin) maxMargin = margin;
        }
      });
      updateLegend(minMargin, maxMargin);
      geojsonLayer.eachLayer(layer => {
        const id = layer.feature.properties.PRECINCT_ID;
        const row = dataMap[id];
        if (row) {
          const margin = parseFloat(row["Percent Difference"]);
          const fillColor = isNaN(margin) ? "#ccc" : chroma.scale(["#2b2d42", "#edf2f4", "#d90429"]).domain([minMargin, 0, maxMargin])(margin);
          layer.setStyle({ fillColor, fillOpacity: 0.7, weight: 1, color: "#555" });

          const content = `
            <strong>Election District:</strong> ${id}<br>
            <strong>Committee Members</strong><br>${row["Committee Members"].replaceAll("\n", "<br>")}<br>
            <br>
            AD: ${row["AD"] || ''}<br>
            SD: ${row["SD"] || ''}<br>
            CD: ${row["CD"] || ''}<br>
            LD: ${row["LD"] || ''}<br>
            <br>
            GOP Candidate Votes: ${row["GOP Candidate Votes"] || ''}<br>
            Opposition Candidate Vote: ${row["Opposition Candidate Vote"] || ''}<br>
            GOP Candidate Percent: ${row["GOP Candidate Percent"] || ''}<br>
            Opposition Candidate Percent: ${row["Opposition Candidate Percent"] || ''}<br>
            Percent Difference: ${row["Percent Difference"] || ''}<br>
            Total Votes: ${row["Total Votes"] || ''}
          `;
          layer.bindPopup(content);
        }
      });
      updateHighlights(csvData);
    }
  });
});

function updateHighlights(data) {
  edLabels.forEach(l => map.removeLayer(l));
  edLabels = [];
  data.forEach(row => {
    if (row["Highlight"] && row["Highlight"].toUpperCase() === "X") {
      geojsonLayer.eachLayer(layer => {
        if (layer.feature.properties.PRECINCT_ID === row["PRECINCT_ID"]) {
          const center = layer.getBounds().getCenter();
          const label = L.divIcon({
            className: 'highlight-label',
            html: `<div style="background:#fff;border:2px solid red;border-radius:50%;width:24px;height:24px;text-align:center;line-height:22px;font-weight:bold;">${row["ED"]}</div>`,
            iconSize: [24, 24]
          });
          const marker = L.marker(center, { icon: label }).addTo(map);
          edLabels.push(marker);
        }
      });
    }
  });
}
</script>
</body>
</html>
