<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Huntington Election District Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body { margin: 0; }
    #map { width: 100%; height: 100vh; }
    #uploadBox {
      position: absolute; top: 10px; left: 10px; z-index: 1000;
      background: white; padding: 10px; border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,.15);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      max-width: 360px;
    }
    .ed-label {
      font-size: 12px; font-weight: bold; color: #000;
      text-shadow: 0 0 2px #fff; text-align: center;
    }
    .ed-label--highlight {
      background: #fff;
      border: 3px solid #e02424;
      border-radius: 50%; width: 28px; height: 28px;
      display: flex; align-items: center; justify-content: center;
      box-shadow: 0 0 6px rgba(0,0,0,0.45);
    }
    .tbl { border-collapse: collapse; width: 100%; font-size: 12px; }
    .tbl td { padding: 2px 4px; border-bottom: 1px solid #eee; }
  </style>
</head>
<body>
<div id="uploadBox">
  <label for="csvFile"><b>Upload CSV</b></label><br>
  <input type="file" id="csvFile" accept=".csv" />
  <p style="font-size:12px; margin-top:4px;">Must include column <code>Committee Members</code>.<br>Optional: <code>Highlight</code> (put X to show).</p>
</div>
<div id="map"></div>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chroma-js/2.1.0/chroma.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6.5.0/turf.min.js"></script>
<script>
const HEADER_ALIASES = {
  'PRECINCT_ID': ['precinct_id','precinct id','precinctid','precinct code','precinct_code'],
  'ED': ['ed','ed number','election district','ed_number'],
  'Zone': ['zone'],
  'Committee Members': ['committee members','committee_members','members'],
  'GOP Candidate Votes': ['republican vote count (c+d)','republican vote count c+d','republican votes c+d','rep vote count (c+d)','gop votes c+d'],
  'Opposition Candidate Vote': ['opposition vote count (a+b)','opposition vote count a+b','opposition votes a+b','opp votes a+b','opposition candidate votes'],
  'Total Votes': ['total votes','votes total','total'],
  'GOP Candidate Percent': ['republican percentage (c+d)','republican percent (c+d)','republican percentage c+d','gop percent','gop percentage'],
  'Opposition Candidate Percent': ['opposition percentage (a+b)','opposition percent (a+b)','opp percent','opposition percentage'],
  'Percent Difference': ['percentage difference (margin republican -opposition)','percentage difference margin republican opposition','margin','gop minus opposition','gop%-opp%']
};

const ALIAS_LOOKUP = {};
for (const [canonical, variants] of Object.entries(HEADER_ALIASES)) {
  for (const v of variants) ALIAS_LOOKUP[v.toLowerCase()] = canonical;
}

function normalizeHeaders(row) {
  const out = {};
  for (const [key, val] of Object.entries(row)) {
    const k = key?.toLowerCase().trim();
    const std = ALIAS_LOOKUP[k] ?? key.trim();
    out[std] = typeof val === 'string' ? val.trim() : val;
  }
  return out;
}

function getColor(value) {
  if (isNaN(value)) return '#ccc';
  const scaled = value / 100;
  return chroma.scale(['#001f3f', 'white', '#8B0000']).domain([-1, 0, 1])(scaled).hex();
}

const map = L.map('map').setView([40.85, -73.4], 12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19,
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

let geojsonLayer;
const labelLayer = L.layerGroup().addTo(map);

function fmtPctSmart(v) {
  const s = String(v ?? '').trim();
  if (s.endsWith('%')) return s;
  const n = Number(s.replace(/[, ]/g, ''));
  return Number.isFinite(n) ? `${n.toFixed(2)}%` : 'â€”';
}

function drawPopup(props) {
  const ed = props.ED ?? props['ED Number'] ?? '';
  let html = `<div style="min-width:260px"><div><strong>Election District:</strong> ${ed}</div>`;
  const members = props['Committee Members'];
  if (members) html += `<hr><div><strong>Committee Members</strong><br>${members.replace(/\n/g, '<br>')}</div>`;

  const order = [
    'AD','SD','CD','LD',
    'GOP Candidate Votes','Opposition Candidate Vote',
    'GOP Candidate Percent','Opposition Candidate Percent','Percent Difference','Total Votes'
  ];
  html += `<hr><table class="tbl">`;
  for (const key of order) {
    if (!props[key]) continue;
    const val = key.toLowerCase().includes('percent') ? fmtPctSmart(props[key]) : props[key];
    html += `<tr><td><b>${key}</b></td><td style="text-align:right">${val}</td></tr>`;
  }
  html += `</table></div>`;
  return html;
}

function isMonitored(props) {
  const raw = props.Highlight ?? props.HIGHLIGHT ?? props.highlight;
  return String(raw ?? '').trim().toUpperCase() === 'X';
}

function loadGeoJSON(data, csvData = null) {
  if (geojsonLayer) map.removeLayer(geojsonLayer);
  labelLayer.clearLayers();

  const csvMap = new Map();
  if (csvData) {
    csvData.forEach(row => {
      const r = normalizeHeaders(row);
      const k = r['PRECINCT_ID'];
      if (k) csvMap.set(String(k).trim(), r);
    });
  }

  data.features.forEach(f => {
    const props = f.properties ?? {};
    const k = props['PRECINCT_ID'] ?? props['PRECINCTID'];
    const row = csvMap.get(String(k).trim());
    if (row) f.properties = { ...props, ...row };
  });

  geojsonLayer = L.geoJSON(data, {
    style: function (feature) {
      const p = feature.properties;
      const val = parseFloat((p['Percent Difference'] || '').replace('%',''));
      return {
        fillColor: getColor(val),
        color: "#333",
        weight: 1,
        fillOpacity: 0.85
      };
    },
    onEachFeature: function (feature, layer) {
      const p = feature.properties;
      layer.bindPopup(drawPopup(p));

      try {
        const center = turf.centroid(feature).geometry.coordinates;
        const labelClass = isMonitored(p) ? 'ed-label ed-label--highlight' : 'ed-label';
        const iconSize = isMonitored(p) ? [28, 28] : [40, 20];
        const iconAnchor = isMonitored(p) ? [14, 14] : [20, 10];
        const edText = p.ED ?? '';
        const label = L.marker([center[1], center[0]], {
          icon: L.divIcon({
            className: labelClass,
            html: `<div>${edText}</div>`,
            iconSize: iconSize,
            iconAnchor: iconAnchor
          }),
          interactive: false
        });
        labelLayer.addLayer(label);
      } catch (e) {}
    }
  }).addTo(map);
}

fetch("Election_District.geojson")
  .then(res => res.json())
  .then(data => loadGeoJSON(data));

document.getElementById("csvFile").addEventListener("change", function (e) {
  const file = e.target.files[0];
  if (!file) return;
  Papa.parse(file, {
    header: true,
    dynamicTyping: false,
    skipEmptyLines: 'greedy',
    complete: function(results) {
      fetch("Election_District.geojson")
        .then(res => res.json())
        .then(data => loadGeoJSON(data, results.data.map(normalizeHeaders)));
    }
  });
});
</script>
</body>
</html>
