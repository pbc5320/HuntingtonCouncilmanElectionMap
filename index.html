<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Huntington Election District Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    #map { width:100%; height:100vh; }
    #ui { position:absolute; top:10px; left:10px; z-index:1000; background:#fff; padding:10px; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,.15); max-width:380px; }
    .muted { color:#555; font-size:12px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .legend { position:absolute; bottom:12px; left:10px; z-index:1000; background:#fff; padding:8px 10px; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,.15); font-size:12px; }
    .legend .scale { height:10px; width:220px; background:linear-gradient(90deg,#0018f9,white,#ff2400); border-radius:4px; margin:6px 0; }
    .legend .ticks { display:flex; justify-content:space-between; }
    .ed-label { font-size:12px; font-weight:600; color:#000; text-shadow:0 0 3px #fff; white-space:nowrap; }
    .tbl { border-collapse:collapse; width:100%; font-size:12px; }
    .tbl td { padding:2px 4px; border-bottom:1px solid #eee; }
  </style>
</head>
<body>
  <div id="ui">
    <div><b>Upload CSV</b></div>
    <input type="file" id="csvFile" accept=".csv"/>
    <div class="muted" style="margin-top:6px">Expected headers (exact):<br>
      <span class="mono">PRECINCT_ID, ED, Zone, Committee Members, Candidate A (Total), Candidate B (Total), Candidate C (Total), Candidate D (Total), Total Votes, Opposition Vote Count(A+B), Opposition Percentage (A+B), Republican Vote Count (C+D), Republican  Percentage (C+D), Percentage Difference (Margin Republican -Opposition)</span>
    </div>
    <div id="status" class="muted" style="margin-top:6px"></div>
  </div>

  <div class="legend">
    <div><b>Fill:</b> Margin (Republican % − Opposition %)</div>
    <div class="scale"></div>
    <div class="ticks"><span>-100%</span><span>0%</span><span>+100%</span></div>
  </div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chroma-js/2.1.0/chroma.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6.5.0/turf.min.js"></script>

  <script>
    // ---- Map setup ----
    const map = L.map('map').setView([40.85, -73.4], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'&copy; OpenStreetMap'}).addTo(map);
    let geojsonLayer; const labels = L.layerGroup().addTo(map);
    const statusEl = document.getElementById('status');

    // ---- Column names (exact) ----
    const COLS = {
      key: 'PRECINCT_ID',
      ed: 'ED',
      zone: 'Zone',
      members: 'Committee Members',
      a: 'Candidate A (Total)',
      b: 'Candidate B (Total)',
      c: 'Candidate C (Total)',
      d: 'Candidate D (Total)',
      total: 'Total Votes',
      oppCount: 'Opposition Vote Count(A+B)',
      oppPct: 'Opposition Percentage (A+B)',
      repCount: 'Republican Vote Count (C+D)',
      repPct: 'Republican  Percentage (C+D)',    // note the double-space per your header
      margin: 'Percentage Difference (Margin Republican -Opposition)'
    };
    const REQUIRED = Object.values(COLS);

    // ---- Helpers ----
    const toNum = v => { const n = Number(String(v??'').replace(/[, ]/g,'')); return Number.isFinite(n)?n:0; };
    const fmtInt = v => isNaN(v)||v==null ? '—' : `${Math.round(v)}`;
    const nl2br = s => String(s??'').replace(/\r?\n/g,'<br>');
    const getColor = (x)=> chroma.scale(['#000080', '#ffffff', '#800000']).mode('lab').domain([-1,0,1])(x).hex();

    // Parse "33.12%" or "33.12" or 0.3312 -> 33.12
    function toPctNumber(v) {
      if (v == null) return null;
      const s = String(v).trim();
      if (s === '') return null;
      if (s.endsWith('%')) {
        const n = parseFloat(s.replace('%','').replace(/[, ]/g,''));
        return Number.isFinite(n) ? n : null;
      }
      const n = Number(s.replace(/[, ]/g,''));
      if (!Number.isFinite(n)) return null;
      return (n >= 0 && n <= 1) ? n * 100 : n;
    }
    function fmtPctSmart(v) {
      if (v == null) return '—';
      const s = String(v).trim();
      if (s.endsWith('%')) return s;
      const n = toPctNumber(v);
      return (n == null) ? '—' : `${n.toFixed(1)}%`;
    }
    function validateHeaders(headers){
      const missing = REQUIRED.filter(h=>!headers.includes(h));
      if(missing.length) throw new Error('Missing columns: ' + missing.join(', '));
    }

    function drawPopup(p){
      const title = p.NAME ?? `ED ${p.ED_Number ?? p[COLS.ed] ?? ''}`;
      const cm = nl2br(p[COLS.members] ?? '');
      const A=toNum(p[COLS.a]), B=toNum(p[COLS.b]), C=toNum(p[COLS.c]), D=toNum(p[COLS.d]);
      const tot=toNum(p[COLS.total]);
      const oppCt=toNum(p[COLS.oppCount]), repCt=toNum(p[COLS.repCount]);

      const oppP=p[COLS.oppPct], repP=p[COLS.repPct], margin=p[COLS.margin];

      let html = `<div style="min-width:260px">`;
      html += `<div><b>Election District:</b> ${title}</div>`;
      if(p[COLS.zone]) html += `<div><b>Zone:</b> ${p[COLS.zone]}</div>`;
      html += `<hr><div><b>Committee Members</b><br>${cm||'—'}</div><hr>`;

      html += `<div><b>Totals</b></div>
      <table class="tbl">
        <tr><td>${COLS.a}</td><td style="text-align:right">${fmtInt(A)}</td></tr>
        <tr><td>${COLS.b}</td><td style="text-align:right">${fmtInt(B)}</td></tr>
        <tr><td>${COLS.c}</td><td style="text-align:right">${fmtInt(C)}</td></tr>
        <tr><td>${COLS.d}</td><td style="text-align:right">${fmtInt(D)}</td></tr>
        <tr><td><b>${COLS.total}</b></td><td style="text-align:right"><b>${fmtInt(tot)}</b></td></tr>
      </table>`;

      html += `<div style="margin-top:6px;"><b>Combined</b></div>
      <table class="tbl">
        <tr><td>${COLS.oppCount}</td><td style="text-align:right">${fmtInt(oppCt)}</td></tr>
        <tr><td>${COLS.oppPct}</td><td style="text-align:right">${fmtPctSmart(oppP)}</td></tr>
        <tr><td>${COLS.repCount}</td><td style="text-align:right">${fmtInt(repCt)}</td></tr>
        <tr><td>${COLS.repPct}</td><td style="text-align:right">${fmtPctSmart(repP)}</td></tr>
        <tr><td><b>${COLS.margin}</b></td><td style="text-align:right"><b>${fmtPctSmart(margin)}</b></td></tr>
      </table>`;
      html += `</div>`;
      return html;
    }

    function applyData(geo, csvRows){
      if(geojsonLayer) map.removeLayer(geojsonLayer);
      labels.clearLayers();

      // Build lookup by PRECINCT_ID
      const byId = new Map();
      for(const r of csvRows){
        if(!r) continue;
        const k = r[COLS.key]!=null ? String(r[COLS.key]).trim() : null;
        if(k) byId.set(k, r);
      }

      // Merge CSV props into GeoJSON
      geo.features.forEach(f=>{
        const p = f.properties || {};
        const key = (p.PRECINCT_ID!=null?String(p.PRECINCT_ID).trim():null) || (p.PRECINCTID!=null?String(p.PRECINCTID).trim():null);
        const row = key ? byId.get(key) : null;
        if(row){ f.properties = { ...p, ...row }; }
      });

      // Draw
      geojsonLayer = L.geoJSON(geo, {
        style: function (feature) {
          // Prefer numeric percent_difference if present; else try CSV margin text
          const mRaw = feature.properties.percent_difference ?? feature.properties[COLS.margin];
          const m = (typeof mRaw === 'number') ? mRaw : toPctNumber(mRaw);
          const norm = (m == null) ? 0 : (m / 100);
          return {
            fillColor: getColor(norm),
            color: "#222",
            weight: 1,
            fillOpacity: 1
          };
        },  // <-- the comma that was missing
        onEachFeature: (feature, layer) => {
          layer.bindPopup(drawPopup(feature.properties));
          try{
            const c = turf.centroid(feature).geometry.coordinates;
            const txt = feature.properties.ED_Number ?? feature.properties[COLS.ed] ?? '';
            const lbl = L.marker([c[1], c[0]], {
              icon: L.divIcon({ className:'ed-label', html:`<div>${txt}</div>`, iconSize:[40,20], iconAnchor:[20,10]}),
              interactive:false
            });
            labels.addLayer(lbl);
          }catch(_){}
        }
      }).addTo(map);
    }

    // Load base GeoJSON
    let baseGeoJSON=null;
    fetch('Election_District.geojson').then(r=>r.json()).then(g=>{ baseGeoJSON=g; applyData(g, []); });

    // CSV upload
    document.getElementById('csvFile').addEventListener('change', e=>{
      const file=e.target.files[0]; if(!file) return;
      Papa.parse(file,{
        header:true, dynamicTyping:false, skipEmptyLines:'greedy',
        complete: res=>{
          try{
            const headers = res.meta.fields || Object.keys(res.data[0]||{});
            validateHeaders(headers);
            applyData(JSON.parse(JSON.stringify(baseGeoJSON)), res.data);
            statusEl.textContent = `Loaded ${res.data.length} rows.`;
          }catch(err){
            statusEl.textContent = err.message;
            alert(err.message);
          }
        }
      });
    });
  </script>
</body>
</html>
